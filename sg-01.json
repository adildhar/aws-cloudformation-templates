{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "tradetracker-sgs (SG rules)",
  "Mappings" : {
    "RegionMap" : {
      "ap-southeast-1" : {
        "vpcid"  : "vpc-cc4a81a8"
      },
      "us-west-2" : {
        "vpccidr" : ""
      },
      "eu-west-1" : {
        "vpccidr" : ""
      },
      "ap-northeast-1" : {
        "vpccidr" : ""
      }
    }
  },
  "Resources": {
    "MyDBSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security Group for RDS -VPC",
        "Tags": [{"Key": "Name","Value": {"Fn::Join": ["-", [{"Ref": "AWS::StackName"}, "MyDBSG"]]}}],
        "VpcId": { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" },  "vpcid" ] }
      }
    },
    "MyELBSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security Group for ELB -Managed VPC",
        "Tags": [{"Key": "Name","Value": {"Fn::Join": ["-", [{"Ref": "AWS::StackName"}, "MyELBSG"]]}}],
        "VpcId": { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" },  "vpcid" ] }
      }
    },
    "AppInstanceSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security Group for Application Instances",
        "Tags": [{"Key": "Name","Value": {"Fn::Join": ["-", [{"Ref": "AWS::StackName"}, "AppInstSG"]]}}],
        "VpcId": { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" },  "vpcid" ] },
        "SecurityGroupIngress": [
          {"IpProtocol": "tcp","FromPort": "22","ToPort": "22","CidrIp": "0.0.0.0/0"},
          {"IpProtocol": "tcp","FromPort": "80","ToPort": "80","SourceSecurityGroupId": {"Ref":"MyELBSG"}},
          {"IpProtocol": "tcp","FromPort": "443","ToPort": "443","SourceSecurityGroupId": {"Ref":"MyELBSG"}} 
        ],
        "SecurityGroupEgress": [
          {"IpProtocol": "tcp","FromPort": "80","ToPort": "80","CidrIp": "0.0.0.0/0"},
          {"IpProtocol": "tcp","FromPort": "443","ToPort": "443","CidrIp": "0.0.0.0/0"},
          {"IpProtocol": "tcp","FromPort": "5432","ToPort": "5432","DestinationSecurityGroupId": {"Ref":"MyDBSG"}}
        ] 
      }
    },
    "MyDBSGIngress0": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "tcp",
        "FromPort": "5432",
        "ToPort": "5432",
        "GroupId": {"Ref": "MyDBSG"},
        "SourceSecurityGroupId": {"Ref": "AppInstanceSecurityGroup"}
      }
    },
    "MyELBSGIngress0": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "tcp",
        "FromPort": "443",
        "ToPort": "443",
        "CidrIp": "0.0.0.0/0",
        "GroupId": {"Ref": "MyELBSG"}
      }
    },
    "MyELBSGIngress1": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "tcp",
        "FromPort": "80",
        "ToPort": "80",
        "CidrIp": "0.0.0.0/0",
        "GroupId": {"Ref": "MyELBSG"}
      }
    }
  },
  "Outputs": {
    "MyDBSGID" : { "Value" :  { "Ref" : "MyDBSG" }, "Description" : "MyDB SG ID" },
    "MyELBSGID" : { "Value" :  { "Ref" : "MyELBSG" }, "Description" : "ELB SG ID" },
    "AppInstanceSecurityGroupID" : { "Value" :  { "Ref" : "AppInstanceSecurityGroup" }, "Description" : "AppInstance SG ID" }
  }
}
